---
title: "VPD Crime Data Exploration"
author: "Zelalem Araya (92797935)"
date: "2024-04-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r moresetup}

suppressPackageStartupMessages(require(rstan))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(magrittr))
suppressPackageStartupMessages(require(tidybayes))
suppressPackageStartupMessages(require(ggmap))
suppressPackageStartupMessages(require(sf))
suppressPackageStartupMessages(require(sp))
suppressPackageStartupMessages(require(leaflet))
suppressPackageStartupMessages(require(geosphere))
```
```{r}

crime_data <- read.csv("VanCrimeData2022.csv")
crime_data <- na.omit(crime_data)
crime_data$longitude <- crime_data$X
crime_data$latitude <- crime_data$Y
crime_data <- crime_data[-c(100:nrow(crime_data)), ]
tail(crime_data)

```

```{r}

crime_data_sf <- st_as_sf(crime_data, coords = c("longitude", "latitude"), crs = 26710) # 26710 code for UTM10
crime_data_sf <- st_transform(crime_data_sf, crs = 4326) # Convert to WGS84

```

```{r}

# Define the bounding box for Vancouver (example coordinates, adjust accordingly)
vancouver_bbox <- st_bbox(c(xmin = -123.2240, xmax = -123.0232, ymin = 49.1980, ymax = 49.3160), crs = st_crs(4326))

# Convert the bounding box to an sf polygon
vancouver_area <- st_as_sfc(vancouver_bbox)

# Define grid size - smaller values result in a finer grid
cellsize <- 0.01  # Degree units; adjust based on desired resolution

# Create a grid over the area
vancouver_grid <- st_make_grid(vancouver_area, cellsize = cellsize, square = TRUE)

# Convert the grid to a simple feature collection for easy manipulation
vancouver_grid_sf <- st_sf(geometry = vancouver_grid)

```

```{r}
area <- read_sf(dsn = "local-area-boundary/local-area-boundary.shp" )

```

```{r}
library(ggplot2)

ggplot() +
  geom_sf(data = area)+
  geom_sf(data = crime_data_sf, aes(color = TYPE)) +
  ggtitle("Crime in Vancouver")

```

```{stan output.var = "canstangeo"}
data {
  int<lower=0> N; // Number of observed data points
  vector[N] y;    // Observed values
  matrix[N, N] distance_matrix; // Matrix of distances between data points
}

parameters {
  real mu; // Mean of the underlying spatial process
  real<lower=0> nugget; // Nugget effect
  real<lower=0> range;  // Range parameter for the spatial correlation
  real<lower=0> sill;   // Sill parameter (total variance)
}

model {
  // Priors for the mean and spatial parameters
  mu ~ normal(0, 1000);
  nugget ~ inv_gamma(0.1, 0.1);
  range ~ normal(0, 1000);
  sill ~ inv_gamma(0.1, 0.1);
  
  // Spatial correlation matrix based on the exponential model
  matrix[N, N] Sigma;
  for (i in 1:N) {
    for (j in i:N) { // The matrix is symmetric
      Sigma[i, j] = sill * exp(-distance_matrix[i, j] / range);
      if (i == j) {
        Sigma[i, j] += nugget; // Adding the nugget effect to the diagonal
      } else {
        Sigma[j, i] = Sigma[i, j]; // Ensuring the matrix is symmetric
      }
    }
  }
  
  // The likelihood of the observed data
  y ~ multi_normal(rep_vector(mu, N), Sigma);
}

generated quantities {
  vector[N] y_pred;
  matrix[N, N] Sigma_Test;
  for (i in 1:N) {
    for (j in i:N) { // The matrix is symmetric
      Sigma_Test[i, j] = sill * exp(-distance_matrix[i, j] / range);
      if (i == j) {
        Sigma_Test[i, j] += nugget; // Adding the nugget effect to the diagonal
      } else {
        Sigma_Test[j, i] = Sigma_Test[i, j]; // Ensuring the matrix is symmetric
      }
    }
  }
  y_pred = multi_normal_rng(rep_vector(0, N), Sigma_Test);
}
```

```{r}
# Extract the coordinates from your sf object
coords <- st_coordinates(crime_data_sf)

# Calculate the distance matrix
dist_matrix <- distm(coords, coords, fun = distHaversine)

# distance_matrix is a matrix where each element [i, j] represents the distance
# between the i-th and j-th points in your dataset, in meters.

```

```{r}

# Assuming you have your distance matrix and crime_data prepared
stan_data <- list(N = nrow(crime_data),
                  y = crime_data$MONTH, 
                  distance_matrix = dist_matrix)
```

```{r message=FALSE, warning=FALSE, results=FALSE, dependson=knitr::dep_prev()}

fit = sampling(
  canstangeo,
  data = stan_data,
  chains = 1,
  refresh = 0,
  iter = 2000
)

print(fit)
```

```{r}
samples <- rstan::extract(fit)
```

```{r}


```
