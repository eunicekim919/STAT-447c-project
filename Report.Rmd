---
title: "A Hierarchical(Kriging) Bayesian Model vs A Hierarchical(Kriging) Model with R and Stan"
author: "Zelalem Araya (92797935) & Youjung Kim (3876269)"
date: "2024-04-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Working link to a public repo:
https://github.com/eunicekim919/STAT-447c-project.git

## Contributions of each team member:

##Introduction (Problem formulation)
* A real-world inference task/problem
* The key modeling/methodological/challenge, clearly associating with the project theme we chose

Our study aims to model the spatial distribution of crimes in Vancouver, utilizing data from the Vancouver Police Department covering the years 2013 to 2019. By analyzing crime records from discrete locations across the city, we seek to provide accurate predictions for future crime occurrences in the particular city in Vancouver. This falls within the realm of spatial data analysis and predictive modeling.

### Data Preprocessing

Upon examining the dataset, we discovered missing 'NEIGHBORHOOD' data for approximately 10.42% of the records, which is 64962 of 624038. However, leveraging the available longitude and latitude coordinates (denoted as X and Y), we can predict the missing neighborhood data, enabling us to proceed with geostatistical modeling.

### Spatial Models

In our study, we explore two Spatial modeling techniques for crime prediction: Universal Kriging and Bayesian Kriging. These models analyze spatially discrete crime data sampled across Vancouver, aiming to predict crime outcomes in various areas of the city.

#### Universal Kringing Model 

The Universal Kriging model employs a spatial covariance function to capture the similarity or correlation between crime counts at different locations. This function, typically a parametric decay function such as the exponential or Gaussian function, describes how spatial correlation diminishes with distance. Here, we utilize the exponential function, parameterized by the range parameter ($\phi$), to control the spatial structure of the model.

*REVISIT*
$k(x_{ij}) = exp(-\phi d_{ij}) + \mathbb{1}_{i=j} \sigma^2$
where $d_{ij} = || x_i - x_j ||$ represents the Euclidean distance between two points, and 
*REVISIT*
$Y_i ~ Bin(m_i, p(x_i))$ for $i = 1,\dots, n$ denotes the observed outcomes from the location $i$

#### Bayesian Kriging Model

Similarly, the Bayesian Kriging model incorporates spatial modeling through a covariance structure, utilizing a parametric function of distance based on longitude and latitude. Within a Bayesian framework, we estimate the parameters of this covariance function, including the length scale parameters, which determine the rate of spatial correlation decay with distance. To be specific,  we use a Bayesian framework to estimate the parameters of this covariance function. A shorter length scale implies that neighbouring locations have a stronger influence on each other, while a longer length scale indicates a more gradual decay of spatial correlation. 

For this Bayesian Kriging model, we specify prior for our parameters and hyperparameters. *ADD HERE*

Both models utilize observed crime counts at training locations to estimate the parameters of the spatial covariance function. Once estimated, the models make predictions for crime counts at unobserved locations using leave-one-out cross-validation. This spatial modeling approach accounts for spatial autocorrelation in crime data, enhancing the accuracy of crime predictions.


##Background 
* sufficient context needed to understand the problem
* Relevant literature is cited and summarized

Martin Wieskotten, Marielle Crozet, Bertrand Iooss, CeÃÅline Lacaux, Amandine Marrel. A comparison between Bayesian and ordinary kriging based on validation criteria: application to radiological characterisation. 2023. hal-03806713v2 (https://hal.science/hal-03806713v2/file/bayeskrig_clean.pdf)

Wiskotten et al. discuss the use of spatial interpolation techniques, specifically ordinary kriging and Bayesian kriging, in the context of radiological characterization for nuclear facility decommissioning projects. Their object is to estimate the quantity and spatial distribution of various radionuclides by performing measurements and using spatial interpolation to predict contamination levels at unobserved locations. In this paper, the usefulness of Bayesian kriging is demonstrated through numerical tests on toy models and a real dataset from the decommissioning project of the CEA Marcoule G3 reactor. To compare the performance of Bayesian kriging with ordinary kriging, they used various way to check the model validation such as the predictive variance adequacy, confidence interval or mean squared error. 

Wiskotten et al. highlight that the Bayesian approach addresses that a common criticism of spatial interpolation methods, the neglect of uncertainty in the esimation of model parameters. By treating model parameters as random variables, Bayesian kringing accounts for this uncertainty, leading to better prediction variances. While Wiskotten et al.'s study focuses on radiological characterization in decommissioning projects, our research centers on predicting crime occurrences in Vancouver using spatial modeling techniques. Our aim is to assess the robustness of the Bayesian kriging approach compared to the universal kriging approach. We will evaluate our models based on the estimates expected log predictive density, the LOO information criterion and root mean squared error(RMSE).



##Methods 

* Bayesian model is precisely described(using ~ notation)
* Prior choice is motivated. If appropriate, several choices are compared or sensitivity analysis is performed. 
* Critical evaluation of the posterior approximation. An appropriate combination of diagnostics, synthetic datasets and other validation strategies.


We used Stan to code and sample from our model. 


* NEED TO REVISIT THIS PART*
Let $Y_i$ represent the crime count at location i, with a spatial relationship defined by a parametric covariance function. The model assumes a Gaussian process, with a mean function and covariance matrix. We use the exponential covariance function, which represents the spatial correlation between crime counts at different locations, with a parameter controlling the rate of decay.
We provide the data and the neighbourhood, the location of the clusters,and the precise locations of longtitude and latitdue of all the points we want to predict. We also provide the matrix with the distance between all points both in the data and in the new locations. 

The observation model is

$Y_i ~ Poisson(\lambda_i)$

where $\lambda$ is the expected crime count at location $i$. The spatial component is modeled using a Gaussian process, with hyperparameters specifying the covariance structure.

#### Prior Choice

In Bayesian analysis, we represents the initial belief about the model parameters to ensure the model is being robust. The following prior distributions are used for the parameters:

* Length scale($\phi$): Controls the spatial correlation decay rate. 
* Noise variance($\sigma^2$): Represents measurement noise. 
* Intercept($\beta_0$): Represents the baseline crime rate. We used normal distribution with mean 0 and standard deviation 10 t provide flexibility in the baseline rate.

To validate the model, we use a Leave-One-Out Cross-Validation (LOO-CV). This technique assess the model's predictive performance by leaving one observation out at a time and predicting its value using the rest of the data.


##Results 

The results from the 'loo' function provide estimates for the expected log predictive density(ELPD), the effective number of parameters and the Leave-One-Out(LOO) information criterion. These metrics offer insights into each of two different model's predictive accuracy and complexity. We used these metrics to compare the Universal Kriging and Bayesian Kriging models, examining which method would yield better predictive performance. 

We built two different Bayesian Kriging models to compare: one using the original data(standard model) and another using the logarithmic transformation(log model). To determine which model have better predictive performance, we employed the 'loo_compare' function to evaluate the fit of the models.The decision between the standard model and the log model allows us to find the suitable model to compare two Kriging models. 

The Expected Log Predictive Density(ELPD) is a measure of the model's predictive performance. A higher ELPD suggest better predictive accuracy. Our standard Bayesian Kringing model had an ELPD estimate of -3039.1 with a standard error of 566.8, indicating some variability in the predictions. The alternative log model using Bayesian Kringing showed a slightly better ELPD of -3028.9 with a standard error of 565.3, suggesting improved predictive performance. 

The effective number of parameters is a measure of model complexity, indicating how much the model has adapted to the data. In our standard Bayesian Kringing model, this value was 383.7 with a standard error of 112.2. The alternative log model had a slightly lower effective number of parameters at 372.9 with a standard error of 111.9, indicating that it might be less prone to overfitting.

The LOO information criterion(LOO-IC) combines the ELPD and the effective number of parameters to estimate the expected predictive error. A lower LOO-IC value indicates better performance. The standard Bayesian Kringing model produced a LOO-IC of 6078.3 with a standard error of 1133.6, while the alternative Bayesian Kringing model yielded a LOO-IC of 6057.7 with a standard error of 1130.6. The lower LOO-IC in the alternative model suggests it has slightly better predictive performance.

These results indicate that the alternative log model has slightly better predictive accuracy and lower complexity compared to the standard Bayesian Kriging model. However, the two model has a very close performance comparison. To further evaluate the models, we plan to compare the Universal Kriging and Bayesian models using the log transformation to see which approach provides more robust predictions.



##Discussion 
- Modifiable Areal Unit Problem (MAUP) may come into play when grouping data

### Posterior Approximation and Validation

We use Markov Chain Monte Carlo (MCMC) to generate samples from the posterior distribution. We employ convergence diagnostics, such as R-hat statistics and trace plots, to ensure the MCMC chains converge. 


##Conclusion
* key limitations

In conclusion, our study demonstrates the effectiveness of Bayesian modeling techniques for crime prediction. Both Universal Kriging and Bayesian Kriging offer valuable insights into the spatial distribution of crimes and provide reliable predictions for law enforcement agencies and urban planners.

One key limitation of our study is the assumption of stationary in the spatial processes(?). Additionally, the choice of priors and hyperparameters may influence the model's performance and generalization ability.

The importance of accounting for uncertainties in spatial modeling, showcasing the relevance of Bayesian methods in such applications.

## Appendix A
* implementation code in the appendix (using Stan)